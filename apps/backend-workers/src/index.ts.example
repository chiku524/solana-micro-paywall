/**
 * Cloudflare Workers Backend - Main Entry Point
 * 
 * This is an example structure for the Workers backend.
 * Replace NestJS modules with Workers route handlers.
 */

import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { logger } from 'hono/logger';
import { errorHandler } from './middleware/error-handler';
import { authMiddleware } from './middleware/auth';

// Route handlers
import { paymentsRoutes } from './routes/payments';
import { merchantsRoutes } from './routes/merchants';
import { contentsRoutes } from './routes/contents';
import { healthRoutes } from './routes/health';

// Environment types
export interface Env {
  // D1 Database
  DB: D1Database;
  
  // KV Cache
  CACHE: KVNamespace;
  
  // Queues
  PAYMENT_QUEUE: Queue;
  WEBHOOK_QUEUE: Queue;
  
  // Environment variables
  JWT_SECRET: string;
  SOLANA_RPC_ENDPOINT: string;
  FRONTEND_URL: string;
  CORS_ORIGIN?: string;
}

// Create Hono app
const app = new Hono<{ Bindings: Env }>();

// Middleware
app.use('*', logger());
app.use('*', cors({
  origin: (origin, c) => {
    const allowedOrigins = c.env.CORS_ORIGIN?.split(',') || ['*'];
    if (allowedOrigins.includes('*') || allowedOrigins.includes(origin)) {
      return origin;
    }
    return null;
  },
  credentials: true,
}));

// Global error handler
app.onError(errorHandler);

// Health check (public)
app.get('/health', ...healthRoutes);

// API routes
const api = new Hono<{ Bindings: Env }>();

// Public routes
api.get('/discover', ...contentsRoutes.discover);
api.get('/merchants/:id/profile', ...merchantsRoutes.getProfile);

// Protected routes (require auth)
api.use('*', authMiddleware);

// Payments
api.post('/payments/create', ...paymentsRoutes.create);
api.post('/payments/verify', ...paymentsRoutes.verify);
api.get('/payments/:id', ...paymentsRoutes.get);

// Merchants
api.get('/merchants', ...merchantsRoutes.list);
api.get('/merchants/:id', ...merchantsRoutes.get);
api.put('/merchants/:id', ...merchantsRoutes.update);

// Contents
api.get('/contents', ...contentsRoutes.list);
api.get('/contents/:id', ...contentsRoutes.get);
api.post('/contents', ...contentsRoutes.create);
api.put('/contents/:id', ...contentsRoutes.update);
api.delete('/contents/:id', ...contentsRoutes.delete);

// Mount API routes
app.route('/api', api);

// 404 handler
app.notFound((c) => {
  return c.json({ error: 'Not Found' }, 404);
});

// Export default handler
export default {
  fetch: app.fetch,
  
  // Queue consumers
  async queue(batch: MessageBatch, env: Env): Promise<void> {
    for (const message of batch.messages) {
      try {
        // Process message based on queue name
        if (message.queue === 'payment-verification') {
          await processPaymentVerification(message.body, env);
        } else if (message.queue === 'webhooks') {
          await processWebhook(message.body, env);
        }
        message.ack();
      } catch (error) {
        console.error('Queue processing error:', error);
        message.retry();
      }
    }
  },
};

// Queue processors
async function processPaymentVerification(data: any, env: Env) {
  // Payment verification logic
  // Ported from payment-verification.processor.ts
}

async function processWebhook(data: any, env: Env) {
  // Webhook delivery logic
  // Ported from webhook.processor.ts
}

