# Cloudflare Workers + Pages Converged Configuration
# This unified configuration combines both Pages and Workers into a single project
#
# Migration Date: 2025-01-15
# Purpose: Fix __NEXT_DATA__ injection and RSC streaming issues

name = "micropaywall"
compatibility_date = "2025-01-15"
compatibility_flags = ["nodejs_compat"]

# Pages configuration
# The Pages build output will be served by the Worker
# Functions directory contains the middleware that injects __NEXT_DATA__
pages_build_output_dir = "apps/web/.vercel/output"

# D1 Database (shared between Pages and Workers)
[[d1_databases]]
binding = "DB"
database_name = "micropaywall-db"
database_id = "9fb849f1-b895-4670-baca-cdec2767f8c4"

# KV Namespace for caching (shared)
[[kv_namespaces]]
binding = "CACHE"
id = "7b095fcc4cb74cc787c1e7a20bf895a0"
preview_id = "0ab7737d5e184851a1127d4ecc4b1102"

# Production environment variables
[vars]
NODE_ENV = "production"
FRONTEND_URL = "https://micropaywall.app"
CORS_ORIGIN = "https://micropaywall.app,https://www.micropaywall.app"

# Routes for custom domain
# NOTE: Routes are managed via Cloudflare Dashboard to avoid deployment conflicts
# If you need to manage routes via wrangler.toml, first unassign them from the dashboard
# [[routes]]
# pattern = "micropaywall.app/*"
# zone_name = "micropaywall.app"

# [[routes]]
# pattern = "api.micropaywall.app/*"
# zone_name = "micropaywall.app"

