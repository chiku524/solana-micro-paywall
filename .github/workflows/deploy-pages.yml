name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Clean previous builds
        working-directory: apps/web
        run: |
          rm -rf .next .cache
          echo "‚úÖ Cleaned previous build artifacts"

      - name: Build Next.js app for Cloudflare Pages
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://api.micropaywall.app' }}
          NEXT_PUBLIC_SOLANA_RPC: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC || 'https://api.devnet.solana.com' }}
          NEXT_PUBLIC_SOLANA_RPC_MAINNET: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC_MAINNET || 'https://api.mainnet-beta.solana.com' }}
          NEXT_PUBLIC_SOLANA_NETWORK: ${{ secrets.NEXT_PUBLIC_SOLANA_NETWORK || 'devnet' }}
          NEXT_PUBLIC_WEB_URL: ${{ secrets.NEXT_PUBLIC_WEB_URL || 'https://micropaywall.app' }}
          # Disable all caching to prevent large cache files
          NEXT_CACHE: false
          WEBPACK_CACHE: false
          # Skip Sentry during Cloudflare build to avoid module resolution errors
          SKIP_SENTRY: 'true'
        run: |
          set -x  # Enable command tracing for debugging
          echo "::group::üî® Building Next.js app for Cloudflare Pages"
          echo "=========================================="
          echo "Build Step Starting"
          echo "=========================================="
          echo ""
          
          echo "::group::üìã Step 1: Running Next.js build"
          echo "Running: npm run build"
          npm run build
          BUILD_EXIT_CODE=$?
          echo "Next.js build exit code: $BUILD_EXIT_CODE"
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Next.js build failed with exit code $BUILD_EXIT_CODE"
            exit 1
          fi
          echo "‚úÖ Next.js build completed successfully"
          echo "::endgroup::"
          echo ""
          
          echo "::group::üìã Step 2: Running @cloudflare/next-on-pages"
          echo "This should generate functions for edge runtime pages"
          echo "Running: npx @cloudflare/next-on-pages"
          echo ""
          npx @cloudflare/next-on-pages
          NEXT_ON_PAGES_EXIT_CODE=$?
          echo ""
          echo "@cloudflare/next-on-pages exit code: $NEXT_ON_PAGES_EXIT_CODE"
          if [ $NEXT_ON_PAGES_EXIT_CODE -ne 0 ]; then
            echo "‚ùå @cloudflare/next-on-pages failed with exit code $NEXT_ON_PAGES_EXIT_CODE"
            exit 1
          fi
          echo "‚úÖ @cloudflare/next-on-pages completed successfully"
          echo "::endgroup::"
          echo ""
          
          echo "::group::üìÅ Verifying build output"
          echo "Checking if .vercel/output was created..."
          if [ -d ".vercel/output" ]; then
            echo "‚úÖ .vercel/output directory found"
            echo ""
            echo "Root directory contents:"
            ls -la .vercel/output
            echo ""
            echo "Checking for functions directory:"
            if [ -d ".vercel/output/functions" ]; then
              echo "‚úÖ Functions directory exists!"
              echo ""
              echo "Functions directory structure:"
              find .vercel/output/functions -type d | head -30
              echo ""
              echo "Functions directory files:"
              find .vercel/output/functions -type f | head -30
              echo ""
              echo "Function count summary:"
              echo "  - Total items: $(find .vercel/output/functions -type f -o -type d | wc -l)"
              echo "  - .func directories: $(find .vercel/output/functions -type d -name "*.func" | wc -l)"
              echo "  - .js files: $(find .vercel/output/functions -name "*.js" | wc -l)"
              echo ""
              if [ "$(find .vercel/output/functions -type d -name "*.func" | wc -l)" -eq 0 ]; then
                echo "‚ö†Ô∏è  WARNING: No .func directories found!"
                echo "This means functions won't be deployed to Cloudflare Pages"
              fi
            else
              echo "‚ùå Functions directory NOT found!"
              echo "This means @cloudflare/next-on-pages did NOT generate functions"
              echo ""
              echo "All directories in .vercel/output:"
              find .vercel/output -type d -maxdepth 1
            fi
          else
            echo "‚ùå .vercel/output directory NOT found!"
            echo "Current directory: $(pwd)"
            echo "Directory contents:"
            ls -la
            exit 1
          fi
          echo "::endgroup::"
          echo ""
          echo "‚úÖ Build complete"
          echo "::endgroup::"

      - name: Check Next.js build output for edge runtime pages
        working-directory: apps/web
        run: |
          echo "::group::üîç Checking Next.js build output for edge runtime pages"
          echo "Checking if Next.js detected edge runtime pages..."
          echo ""
          if [ -d ".next" ]; then
            echo "‚úÖ .next directory exists"
            echo ""
            echo "Checking for marketplace route in .next/server/app:"
            if [ -d ".next/server/app/marketplace" ]; then
              echo "‚úÖ Marketplace route found in build output"
              echo ""
              echo "Checking if it's marked as edge runtime:"
              find .next/server/app/marketplace -name "*.js" -o -name "*.json" | head -10
              echo ""
              echo "Checking route manifest:"
              if [ -f ".next/routes-manifest.json" ]; then
                echo "Routes manifest contents:"
                cat .next/routes-manifest.json | grep -A 5 -B 5 marketplace || echo "No marketplace in routes manifest"
              fi
            else
              echo "‚ö†Ô∏è  Marketplace route not found in .next/server/app"
              echo "Available routes:"
              ls -la .next/server/app/ 2>/dev/null | head -20
            fi
          else
            echo "‚ùå .next directory not found"
          fi
          echo "::endgroup::"

      - name: Verify build output structure
        working-directory: apps/web
        run: |
          echo "::group::üìÅ Verifying .vercel/output structure"
          echo "=========================================="
          if [ ! -d ".vercel/output" ]; then
            echo "‚ùå ERROR: .vercel/output directory not found after build!"
            exit 1
          fi
          echo "‚úÖ Found .vercel/output directory"
          echo ""
          echo "üìÇ Root directory contents:"
          ls -lah .vercel/output || echo "Cannot list directory"
          echo ""
          
          # Check for static directory
          if [ ! -d ".vercel/output/static" ]; then
            echo "‚ùå ERROR: static directory not found in .vercel/output"
            exit 1
          fi
          echo "‚úÖ Found static directory"
          echo "   Size: $(du -sh .vercel/output/static | cut -f1)"
          
          # Check for functions directory - CRITICAL for Next.js routing
          echo ""
          echo "üîç Checking for functions directory..."
          if [ ! -d ".vercel/output/functions" ]; then
            echo ""
            echo "‚ùå CRITICAL ERROR: functions directory not found!"
            echo "   This is required for Next.js routing on Cloudflare Pages"
            echo "   Without it, all routes will return 404 or 503"
            echo ""
            echo "   Checking what @cloudflare/next-on-pages actually generated..."
            echo "   All directories in .vercel/output:"
            find .vercel/output -type d -maxdepth 1
            echo ""
            echo "   All files in .vercel/output root:"
            find .vercel/output -maxdepth 1 -type f
            echo ""
            echo "   This means @cloudflare/next-on-pages did NOT generate functions!"
            echo "   Possible causes:"
            echo "   1. Next.js is statically generating all pages (ignoring edge runtime)"
            echo "   2. @cloudflare/next-on-pages version issue or bug"
            echo "   3. Next.js build configuration issue"
            echo "   4. Pages with edge runtime are not being detected"
            echo ""
            echo "   Checking if marketplace.html exists (static generation):"
            ls -la .vercel/output/static/marketplace.html 2>&1 || echo "   marketplace.html not found (good - should be dynamic)"
            exit 1
          fi
          echo "‚úÖ Found functions directory (needed for routing)"
          echo "   Size: $(du -sh .vercel/output/functions | cut -f1)"
          echo ""
          echo "üìã Functions directory detailed listing:"
          ls -lah .vercel/output/functions | head -30
          echo ""
          echo "üìä Function count:"
          echo "   Directories: $(find .vercel/output/functions -type d | wc -l)"
          echo "   Files: $(find .vercel/output/functions -type f | wc -l)"
          echo ""
          
          # Verify key files exist
          echo "üîç Verifying key routing files..."
          if [ -f ".vercel/output/functions/[[path]].js" ] || [ -d ".vercel/output/functions/[[path]]" ] || [ -d ".vercel/output/functions/[[path]].func" ]; then
            echo "‚úÖ Found catch-all route handler ([[path]])"
            if [ -d ".vercel/output/functions/[[path]].func" ]; then
              echo "   Type: .func directory"
              ls -la .vercel/output/functions/[[path]].func/ | head -10
            elif [ -f ".vercel/output/functions/[[path]].js" ]; then
              echo "   Type: .js file"
            fi
          else
            echo "‚ö†Ô∏è  WARNING: Catch-all route handler not found - checking functions structure..."
            echo "   Functions directory contents:"
            ls -lah .vercel/output/functions | head -20
            echo ""
            echo "   Searching for any [[path]] files:"
            find .vercel/output/functions -name "*path*" -o -name "*\[*" | head -10
          fi
          
          if [ -f ".vercel/output/config.json" ]; then
            echo "‚úÖ Found config.json"
          else
            echo "‚ö†Ô∏è  WARNING: config.json not found"
          fi
          
          echo ""
          echo "üìä Build output summary:"
          echo "   Static files: $(find .vercel/output/static -type f 2>/dev/null | wc -l) files"
          echo "   Functions: $(find .vercel/output/functions -type f 2>/dev/null | wc -l) files"

      - name: Clean build output for deployment
        working-directory: apps/web
        run: |
          echo "üßπ Cleaning build output..."
          # Remove cache directories from .next before Cloudflare build
          rm -rf .next/cache cache .cache node_modules/.cache 2>/dev/null || true
          find .next -type d -name "cache" -exec rm -rf {} + 2>/dev/null || true
          find . -maxdepth 1 -type d -name "cache" -exec rm -rf {} + 2>/dev/null || true
          # Remove webpack pack files
          find .next -name "*.pack" -type f -delete 2>/dev/null || true
          find . -maxdepth 1 -name "*.pack" -type f -delete 2>/dev/null || true
          echo "‚úÖ Cleaned cache files before build"
      
      - name: Clean Cloudflare Pages output for deployment
        working-directory: apps/web
        run: |
          echo "üßπ Cleaning Cloudflare Pages output..."
          # Clean output directory if it exists
          rm -rf .vercel/output/static/cache 2>/dev/null || true
          # Remove any files larger than 25MB (Cloudflare Pages limit)
          find .vercel/output -type f -size +25M -exec rm -f {} + 2>/dev/null || true
          # Verify no large files remain
          echo "üìä Checking for remaining large files (>20MB)..."
          if [ -d ".vercel/output" ]; then
            LARGE_FILES=$(find .vercel/output -type f -size +20M 2>/dev/null | wc -l)
            if [ "$LARGE_FILES" -gt 0 ]; then
              echo "‚ö†Ô∏è  Found $LARGE_FILES large file(s):"
              find .vercel/output -type f -size +20M -exec ls -lh {} \; 2>/dev/null | head -10
              exit 1
            else
              echo "‚úÖ No large files found in output"
            fi
            echo "üìÅ Deployment directory structure (.vercel/output):"
            du -sh .vercel/output 2>/dev/null || echo "No output directory"
            echo "üìÅ Contents:"
            ls -lah .vercel/output 2>/dev/null || echo "Cannot list output"
          fi

      - name: List deployment structure before deploy
        working-directory: apps/web
        run: |
          echo "üì¶ Final deployment structure check:"
          echo ""
          echo "Root of .vercel/output:"
          ls -la .vercel/output/ | head -20
          echo ""
          echo "Static directory contents (first 10 items):"
          ls -la .vercel/output/static/ | head -10 || echo "Static not found"
          echo ""
          echo "Functions directory structure:"
          find .vercel/output/functions -type f -name "*.js" | head -10 || echo "No JS files in functions"
          echo ""
          echo "Functions directory full listing:"
          ls -la .vercel/output/functions/ 2>/dev/null | head -20 || echo "Functions directory empty or not found"
          echo ""
          echo "Checking for catch-all route:"
          ls -la .vercel/output/functions/ 2>/dev/null | grep -E "\[\[path\]\]|_worker|index" || echo "Catch-all route not found"
          echo ""
          echo "Checking for marketplace function:"
          ls -la .vercel/output/functions/ 2>/dev/null | grep -i marketplace || echo "Marketplace function not found"
          echo ""
          echo "Function directories count:"
          find .vercel/output/functions -type d -name "*.func" 2>/dev/null | wc -l || echo "0"
          echo ""
          echo "Checking for config.json:"
          cat .vercel/output/config.json 2>/dev/null || echo "config.json not found or not readable"
          echo ""
          echo "Verifying index.html exists:"
          ls -la .vercel/output/static/index.html 2>/dev/null || echo "index.html not found in static directory"

      - name: Verify critical files for routing
        working-directory: apps/web
        run: |
          echo "üîç Verifying critical routing files..."
          echo ""
          
          # Check for homepage files (index.html or prerender fallback)
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "‚úÖ Found index.html"
          elif [ -f ".vercel/output/static/index.prerender-fallback.html" ]; then
            echo "‚úÖ Found index.prerender-fallback.html (homepage fallback)"
          else
            echo "‚ö†Ô∏è  WARNING: No homepage file found (index.html or index.prerender-fallback.html)"
            echo "   Static directory contents:"
            ls -la .vercel/output/static/ | grep -E "index|404" | head -10
          fi
          
          # Check for functions directory
          if [ ! -d ".vercel/output/functions" ]; then
            echo "‚ùå ERROR: functions directory not found!"
            exit 1
          fi
          echo "‚úÖ Found functions directory"
          
          # Check for index function (homepage route handler)
          if [ -d ".vercel/output/functions/index.func" ] || [ -L ".vercel/output/functions/index.func" ]; then
            echo "‚úÖ Found index.func (homepage route handler)"
            # Check if it's a symlink and where it points
            if [ -L ".vercel/output/functions/index.func" ]; then
              LINK_TARGET=$(readlink .vercel/output/functions/index.func)
              echo "   ‚ö†Ô∏è  WARNING: index.func is a symlink pointing to: $LINK_TARGET"
              if [[ "$LINK_TARGET" != "index.rsc.func" ]] && [[ "$LINK_TARGET" != "./index.rsc.func" ]]; then
                echo "   ‚ùå ERROR: index.func should point to index.rsc.func, not $LINK_TARGET"
                echo "   This is likely causing the 404 error!"
              fi
            fi
          else
            echo "‚ö†Ô∏è  WARNING: index.func not found - checking for alternative structure..."
            ls -la .vercel/output/functions/ | grep -E "index|^\.\.?$" | head -10
          fi
          
          # Check for catch-all route handler (may not exist if all routes are pre-rendered)
          if [ -f ".vercel/output/functions/[[path]].js" ] || [ -d ".vercel/output/functions/[[path]].func" ] || [ -d ".vercel/output/functions/[[path]]" ]; then
            echo "‚úÖ Found catch-all route handler ([[path]])"
          else
            echo "‚ö†Ô∏è  WARNING: Catch-all route handler ([[path]]) not found"
            echo "   This may be OK if all routes are pre-rendered, but dynamic routes won't work"
            echo "   Functions directory contents:"
            ls -la .vercel/output/functions/ | head -15
          fi
          
          # Check for config.json and examine routing configuration
          if [ -f ".vercel/output/config.json" ]; then
            echo "‚úÖ Found config.json"
            echo "   Checking routing configuration..."
            if grep -q "routes" .vercel/output/config.json 2>/dev/null; then
              echo "   Routing configuration found in config.json"
            else
              echo "   ‚ö†Ô∏è  WARNING: No routing configuration found in config.json"
            fi
            echo "   Config.json preview (first 30 lines):"
            cat .vercel/output/config.json | head -30
          else
            echo "‚ùå ERROR: config.json not found - this is required!"
            exit 1
          fi
          
          # Check for middleware function
          if [ -d ".vercel/output/functions/middleware.func" ]; then
            echo "‚úÖ Found middleware.func"
          else
            echo "‚ö†Ô∏è  WARNING: middleware.func not found (middleware may not be working)"
          fi
          
          echo ""
          echo "üìä Summary:"
          echo "   Static files: $(find .vercel/output/static -type f 2>/dev/null | wc -l)"
          echo "   Function directories: $(find .vercel/output/functions -type d -name "*.func" 2>/dev/null | wc -l)"
          echo ""
          echo "‚úÖ Critical files verification complete"

      - name: Fix broken homepage route handler
        working-directory: apps/web
        run: |
          echo "üîß Fixing broken homepage route handler..."
          echo ""
          
          # First, diagnose the current state
          echo "üìã Current state:"
          if [ -L ".vercel/output/functions/index.func" ]; then
            LINK_TARGET=$(readlink .vercel/output/functions/index.func)
            echo "   index.func is a symlink ‚Üí $LINK_TARGET"
          elif [ -d ".vercel/output/functions/index.func" ]; then
            echo "   index.func is a directory"
          else
            echo "   index.func doesn't exist"
          fi
          
          # Check if index.rsc.func exists and what's in it
          if [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   ‚úÖ index.rsc.func directory exists"
            echo "   Contents of index.rsc.func:"
            ls -la .vercel/output/functions/index.rsc.func/ | head -10
            if [ -f ".vercel/output/functions/index.rsc.func/index.js" ]; then
              echo "   ‚úÖ index.js exists in index.rsc.func"
              echo "   First 20 lines of index.js:"
              head -20 .vercel/output/functions/index.rsc.func/index.js || echo "   Could not read index.js"
            else
              echo "   ‚ö†Ô∏è  index.js NOT found in index.rsc.func"
            fi
          else
            echo "   ‚ùå index.rsc.func directory does NOT exist"
          fi
          
          # Check static index.html
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "   ‚úÖ static/index.html exists ($(wc -c < .vercel/output/static/index.html) bytes)"
          else
            echo "   ‚ùå static/index.html NOT found"
          fi
          
          echo ""
          echo "üîß Applying fix strategy..."
          
          # Strategy: Since homepage is a pre-rendered client component, 
          # remove ALL function route handlers (both symlink and directory) and let Cloudflare serve the static file
          # This is more reliable for pre-rendered pages
          
          # Remove the symlink if it exists
          if [ -L ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.func" ]; then
            echo "   Removing index.func (function route handler symlink/directory)"
            rm -rf .vercel/output/functions/index.func
            echo "   ‚úÖ Removed index.func"
          fi
          
          # CRITICAL: Also remove index.rsc.func directory - Cloudflare Pages will try to use it
          # even if index.func is removed, causing 404 errors
          if [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   Removing index.rsc.func directory (function route handler)"
            rm -rf .vercel/output/functions/index.rsc.func
            echo "   ‚úÖ Removed index.rsc.func directory"
            echo "   ‚ÑπÔ∏è  This prevents Cloudflare from trying to use a broken function route"
          fi
          
          echo "   ‚ÑπÔ∏è  Cloudflare will now serve static/index.html for the homepage"
          
          # CRITICAL FIX: Cloudflare Pages requires index.html at root OR a catch-all route handler
          # Since we removed function handlers, ensure index.html is accessible at root level
          # This is a fallback to ensure Cloudflare Pages can find the homepage
          echo ""
          echo "üîß Creating root-level index.html (Cloudflare Pages requirement)..."
          if [ -f ".vercel/output/static/index.html" ]; then
            if [ -f ".vercel/output/index.html" ]; then
              echo "   ‚ÑπÔ∏è  Root-level index.html already exists"
            else
              echo "   üìã Copying static/index.html to root level"
              cp .vercel/output/static/index.html .vercel/output/index.html
              echo "   ‚úÖ Created root-level index.html"
              echo "   ‚ÑπÔ∏è  This ensures Cloudflare Pages can serve the homepage"
            fi
            # Verify it was created
            if [ -f ".vercel/output/index.html" ]; then
              echo "   ‚úÖ Verified: root-level index.html exists ($(wc -c < .vercel/output/index.html) bytes)"
            else
              echo "   ‚ùå ERROR: Failed to create root-level index.html"
              exit 1
            fi
          else
            echo "   ‚ùå ERROR: static/index.html not found - cannot create root-level index.html"
            exit 1
          fi
          
          # CRITICAL: Ensure _next directory is accessible at root level for CSS/JS assets
          # The HTML references /_next/static/... but files are in static/_next/static/...
          # Cloudflare Pages needs _next at root level for assets to load
          echo ""
          echo "üîß Ensuring _next directory is accessible for CSS/JS assets..."
          if [ -d ".vercel/output/static/_next" ]; then
            if [ -d ".vercel/output/_next" ]; then
              echo "   ‚ÑπÔ∏è  Root-level _next already exists"
            else
              echo "   üìã Copying _next directory to root level (for CSS/JS assets)"
              # Use cp -r to copy the directory (symlinks might not work in deployment)
              cp -r .vercel/output/static/_next .vercel/output/_next
              echo "   ‚úÖ Copied _next directory to root level"
              echo "   ‚ÑπÔ∏è  This ensures CSS/JS assets are accessible at /_next/static/..."
            fi
            # Verify it was created
            if [ -d ".vercel/output/_next" ]; then
              echo "   ‚úÖ Verified: _next is accessible at root level"
              if [ -d ".vercel/output/_next/static" ]; then
                echo "   Checking _next/static structure:"
                ls -la .vercel/output/_next/static/ 2>/dev/null | head -5
                CSS_FILES=$(find .vercel/output/_next/static -name "*.css" 2>/dev/null | wc -l)
                JS_FILES=$(find .vercel/output/_next/static -name "*.js" 2>/dev/null | wc -l)
                echo "   Found: $CSS_FILES CSS files, $JS_FILES JS files in _next/static"
              fi
            else
              echo "   ‚ùå ERROR: Failed to create _next directory - CSS/JS won't load"
              exit 1
            fi
          else
            echo "   ‚ö†Ô∏è  WARNING: static/_next directory not found - CSS/JS files might be missing"
            echo "   Listing static directory contents:"
            ls -la .vercel/output/static/ | head -10
          fi
          
          # Also check and fix dashboard.func if it has the same issue
          if [ -L ".vercel/output/functions/dashboard.func" ]; then
            DASHBOARD_TARGET=$(readlink .vercel/output/functions/dashboard.func)
            if [[ "$DASHBOARD_TARGET" == "bookmarks.rsc.func" ]]; then
              echo "   üîß Fixing dashboard.func symlink..."
              rm -f .vercel/output/functions/dashboard.func
              if [ -d ".vercel/output/functions/dashboard.rsc.func" ]; then
                ln -s dashboard.rsc.func .vercel/output/functions/dashboard.func
                echo "   ‚úÖ Fixed dashboard.func"
              elif [ -d ".vercel/output/functions/dashboard" ]; then
                echo "   ‚ÑπÔ∏è  dashboard is a directory - no function symlink needed"
              else
                echo "   ‚ö†Ô∏è  dashboard.rsc.func not found - removed broken symlink"
              fi
            fi
          fi
          
          echo ""
          echo "‚úÖ Route handler fix complete"
          echo ""
          echo "üìã Final state:"
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "   ‚úÖ static/index.html exists - homepage will be served as static file"
            echo "   File size: $(wc -c < .vercel/output/static/index.html) bytes"
            echo "   First line: $(head -1 .vercel/output/static/index.html | cut -c1-80)"
          else
            echo "   ‚ùå static/index.html missing - this will cause 404!"
          fi
          
          if [ -L ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.func" ]; then
            echo "   ‚ö†Ô∏è  index.func still exists (should have been removed)"
          else
            echo "   ‚úÖ index.func removed - using static file serving"
          fi
          
          if [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   ‚ö†Ô∏è  index.rsc.func still exists (should have been removed)"
          else
            echo "   ‚úÖ index.rsc.func removed - using static file serving"
          fi
          
          # CRITICAL: Verify root-level index.html exists
          echo ""
          echo "üîç Final verification - root-level index.html:"
          if [ -f ".vercel/output/index.html" ]; then
            echo "   ‚úÖ Root-level index.html EXISTS - Cloudflare Pages can serve homepage"
            echo "   File size: $(wc -c < .vercel/output/index.html) bytes"
          else
            echo "   ‚ùå ERROR: Root-level index.html MISSING!"
            echo "   This will cause 404 errors - the copy step must have failed"
            exit 1
          fi
          
          # Verify no index-related functions remain
          echo ""
          echo "üîç Checking for any remaining index-related functions:"
          ls -la .vercel/output/functions/ | grep -E "^[^d].*index|^d.*index" || echo "   ‚úÖ No index-related functions found"

      - name: Verify static file serving configuration
        working-directory: apps/web
        run: |
          echo "üîç Verifying static file serving configuration..."
          echo ""
          
          # Check if 404.html exists (Cloudflare uses this for SPA routing)
          if [ -f ".vercel/output/static/404.html" ]; then
            echo "‚úÖ Found 404.html"
            echo "   This is used by Cloudflare Pages for handling unknown routes"
          else
            echo "‚ö†Ô∏è  404.html not found"
            echo "   This might be needed for client-side routing"
          fi
          
          # Verify index.html is in the correct location
          echo ""
          echo "üìã Verifying static/index.html:"
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "   ‚úÖ static/index.html exists"
            echo "   Location: .vercel/output/static/index.html"
            echo "   Size: $(wc -c < .vercel/output/static/index.html) bytes"
            echo "   First 100 chars: $(head -c 100 .vercel/output/static/index.html)"
          else
            echo "   ‚ùå static/index.html NOT FOUND - this will cause 404!"
            echo "   Listing static directory:"
            ls -la .vercel/output/static/ | head -20
          fi
          
          # Check config.json routing rules
          if [ -f ".vercel/output/config.json" ]; then
            echo ""
            echo "üìã Checking config.json routing rules:"
            # Look for rules that might interfere with homepage serving
            if grep -q '"src": "/"' .vercel/output/config.json 2>/dev/null; then
              echo "   ‚ö†Ô∏è  Found routing rule for '/' - checking if it interferes:"
              grep -A 5 '"src": "/"' .vercel/output/config.json | head -10
            else
              echo "   ‚úÖ No explicit routing rule for '/' - static file will be served"
            fi
            
            # Check for redirect rules
            if grep -q '"status": 30' .vercel/output/config.json 2>/dev/null; then
              echo "   ‚ö†Ô∏è  Found redirect rules - checking:"
              grep -B 2 -A 3 '"status": 30' .vercel/output/config.json | head -15
            fi
          fi
          
          # Final check: Ensure no function routes interfere with homepage
          echo ""
          echo "üîç Final check - ensuring no function routes for homepage:"
          if [ -L ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   ‚ùå ERROR: Function route handlers still exist for homepage!"
            echo "   This will prevent static file serving"
            echo "   Remaining files:"
            ls -la .vercel/output/functions/ | grep index
            exit 1
          else
            echo "   ‚úÖ No function route handlers for homepage - static file will be served"
          fi
          
          echo ""
          echo "‚úÖ Configuration verification complete"

      - name: Pre-deployment structure verification
        working-directory: apps/web
        run: |
          echo "üîç Final pre-deployment verification..."
          echo ""
          echo "üìÅ Root of .vercel/output:"
          ls -la .vercel/output/ | head -15
          echo ""
          echo "üìÅ Static directory (should contain index.html):"
          ls -la .vercel/output/static/ | grep -E "index|^total|^d" | head -10
          echo ""
          echo "üìÅ Functions directory:"
          ls -la .vercel/output/functions/ | head -10
          echo ""
          
          # Verify root-level index.html exists (critical for Cloudflare Pages)
          echo ""
          echo "üîç Verifying root-level index.html..."
          if [ -f ".vercel/output/index.html" ]; then
            echo "   ‚úÖ Root-level index.html exists ($(wc -c < .vercel/output/index.html) bytes)"
          else
            echo "   ‚ùå ERROR: Root-level index.html missing!"
            echo "   This is required for Cloudflare Pages to serve the homepage"
            exit 1
          fi
          
          # Verify _next directory is accessible for CSS/JS
          echo ""
          echo "üîç Verifying _next directory for CSS/JS assets..."
          if [ -d ".vercel/output/_next" ] || [ -L ".vercel/output/_next" ]; then
            echo "   ‚úÖ _next directory is accessible at root level"
            if [ -d ".vercel/output/_next/static" ]; then
              CSS_COUNT=$(find .vercel/output/_next/static -name "*.css" 2>/dev/null | wc -l)
              JS_COUNT=$(find .vercel/output/_next/static -name "*.js" 2>/dev/null | wc -l)
              echo "   Found: $CSS_COUNT CSS files, $JS_COUNT JS files"
              if [ "$CSS_COUNT" -eq 0 ]; then
                echo "   ‚ö†Ô∏è  WARNING: No CSS files found - styling won't work!"
              fi
            else
              echo "   ‚ö†Ô∏è  WARNING: _next/static directory not found"
            fi
          else
            echo "   ‚ùå ERROR: _next directory not accessible at root level!"
            echo "   CSS/JS assets won't load - this will cause styling issues"
            echo "   Checking if static/_next exists:"
            ls -la .vercel/output/static/ | grep _next || echo "   static/_next not found"
            exit 1
          fi
          
          # Check for catch-all route handler (optional but helpful)
          echo ""
          echo "üîç Checking for catch-all route handler..."
          if [ -f ".vercel/output/functions/[[path]].js" ] || [ -d ".vercel/output/functions/[[path]].func" ] || [ -d ".vercel/output/functions/[[path]]" ]; then
            echo "   ‚úÖ Catch-all route handler exists"
          else
            echo "   ‚ÑπÔ∏è  No catch-all route handler (this is OK if index.html is at root)"
          fi
          
          # Verify key routes exist
          echo ""
          echo "üîç Verifying key routes are built..."
          ROUTES=("marketplace" "docs" "dashboard")
          for route in "${ROUTES[@]}"; do
            if [ -f ".vercel/output/static/${route}.html" ]; then
              echo "   ‚úÖ Route /${route} exists as static HTML"
            elif [ -d ".vercel/output/functions/${route}.func" ]; then
              echo "   ‚úÖ Route /${route} exists as function (${route}.func)"
            elif [ -d ".vercel/output/functions/${route}.rsc.func" ]; then
              echo "   ‚úÖ Route /${route} exists as RSC function (${route}.rsc.func)"
            elif [ -f ".vercel/output/functions/[[path]].js" ] || [ -d ".vercel/output/functions/[[path]].func" ]; then
              echo "   ‚úÖ Route /${route} will be handled by catch-all [[path]] function"
            else
              echo "   ‚ùå ERROR: Route /${route} NOT found in build output!"
              echo "      This route will return 404 or 503!"
              echo "      Checking functions directory for ${route}:"
              ls -la .vercel/output/functions/ 2>/dev/null | grep -i "${route}" || echo "      No ${route} function found"
              echo "      All functions:"
              ls -la .vercel/output/functions/ 2>/dev/null | head -20
            fi
          done
          
          # CRITICAL: Verify catch-all route exists for dynamic routes
          echo ""
          echo "üîç Verifying catch-all route handler..."
          if [ -f ".vercel/output/functions/[[path]].js" ] || [ -d ".vercel/output/functions/[[path]].func" ] || [ -d ".vercel/output/functions/[[path]]" ]; then
            echo "   ‚úÖ Catch-all route handler exists - dynamic routes should work"
          else
            echo "   ‚ùå ERROR: Catch-all route handler NOT found!"
            echo "   Without [[path]], dynamic routes like /marketplace will return 503!"
            echo "   Functions directory contents:"
            ls -la .vercel/output/functions/ 2>/dev/null | head -20
            echo ""
            echo "   This is a CRITICAL error - deployment will fail for dynamic routes!"
          fi
          
          echo ""
          echo "‚úÖ Verification complete - ready to deploy"

      - name: Verify functions will be deployed
        working-directory: apps/web
        run: |
          echo "üîç Final check before deployment..."
          echo ""
          echo "üìä Complete .vercel/output structure:"
          tree -L 3 .vercel/output 2>/dev/null || find .vercel/output -maxdepth 3 -type d | head -30
          echo ""
          if [ -d ".vercel/output/functions" ]; then
            echo "‚úÖ Functions directory exists"
            echo ""
            echo "üìã Detailed functions directory analysis:"
            echo "   All items in functions directory:"
            ls -laR .vercel/output/functions | head -100
            echo ""
            echo "   Function directories (.func):"
            find .vercel/output/functions -type d -name "*.func" | head -30
            echo ""
            echo "   Function JavaScript files:"
            find .vercel/output/functions -name "*.js" | head -30
            echo ""
            echo "   Total function directories: $(find .vercel/output/functions -type d -name "*.func" | wc -l)"
            echo "   Total function files: $(find .vercel/output/functions -type f | wc -l)"
            echo ""
            if [ "$(find .vercel/output/functions -type d -name "*.func" | wc -l)" -eq 0 ]; then
              echo "   ‚ö†Ô∏è  CRITICAL WARNING: No .func directories found!"
              echo "   This means functions won't be deployed to Cloudflare Pages"
              echo "   @cloudflare/next-on-pages should create .func directories for edge runtime pages"
              echo ""
              echo "   Checking if functions are in a different format:"
              find .vercel/output/functions -type f -o -type d | head -50
              echo ""
              echo "   This is likely why no functions appear in Cloudflare Pages!"
            else
              echo "   ‚úÖ Functions found - they should be deployed"
            fi
          else
            echo "‚ùå ERROR: Functions directory doesn't exist!"
            echo "   This means @cloudflare/next-on-pages did NOT generate functions"
            echo "   All directories in .vercel/output:"
            find .vercel/output -type d -maxdepth 1
            exit 1
          fi
          echo ""
          echo "üìã Checking config.json for function routing:"
          if [ -f ".vercel/output/config.json" ]; then
            cat .vercel/output/config.json | head -50
          fi

      - name: Final verification before deployment
        working-directory: apps/web
        run: |
          echo "::group::üîç Final verification - functions ready for deployment"
          echo "Verifying marketplace.func exists and has correct structure..."
          if [ -d ".vercel/output/functions/marketplace.func" ]; then
            echo "‚úÖ marketplace.func directory exists"
            echo "   Contents:"
            ls -la .vercel/output/functions/marketplace.func/ | head -10
            echo ""
            echo "   Checking for required files:"
            if [ -f ".vercel/output/functions/marketplace.func/.vc-config.json" ]; then
              echo "   ‚úÖ .vc-config.json exists"
            fi
            if [ -f ".vercel/output/functions/marketplace.func/index.js" ] || [ -f ".vercel/output/functions/marketplace.func/___next_launcher.cjs" ]; then
              echo "   ‚úÖ Entry point file exists"
            fi
          else
            echo "‚ùå marketplace.func NOT found!"
            echo "   This means functions won't be deployed"
            exit 1
          fi
          echo ""
          echo "All .func directories that will be deployed:"
          find .vercel/output/functions -type d -name "*.func" | sort
          echo "::endgroup::"

      - name: Install wrangler
        run: |
          echo "üì¶ Installing wrangler..."
          npm install -g wrangler@latest
          echo "‚úÖ Wrangler installed"
          wrangler --version

      - name: Deploy to Cloudflare Pages
        working-directory: apps/web
        run: |
          echo "üöÄ Deploying to Cloudflare Pages using wrangler..."
          echo "   This ensures functions are properly deployed"
          echo ""
          echo "   Verifying .vercel/output exists:"
          ls -la .vercel/output | head -5
          echo ""
          echo "   Verifying functions directory exists:"
          ls -la .vercel/output/functions | head -10
          echo ""
          echo "   Verifying marketplace.func exists:"
          if [ -d ".vercel/output/functions/marketplace.func" ]; then
            echo "   ‚úÖ marketplace.func found"
            ls -la .vercel/output/functions/marketplace.func/ | head -5
          else
            echo "   ‚ùå marketplace.func NOT found!"
            exit 1
          fi
          echo ""
          echo "   CRITICAL: Checking if static marketplace.html exists (this would override the function):"
          if [ -f ".vercel/output/static/marketplace.html" ]; then
            echo "   ‚ö†Ô∏è  WARNING: static/marketplace.html EXISTS!"
            echo "   This static file will be served instead of the marketplace.func function"
            echo "   This is why users see landing page content on /marketplace"
            echo "   Removing static marketplace.html to allow function to handle the route..."
            rm -f .vercel/output/static/marketplace.html
            echo "   ‚úÖ Removed static marketplace.html"
          else
            echo "   ‚úÖ No static marketplace.html (good - function will handle the route)"
          fi
          echo ""
          echo "   Checking config.json routing for marketplace:"
          if [ -f ".vercel/output/config.json" ]; then
            echo "   Marketplace route configuration:"
            cat .vercel/output/config.json | grep -A 3 -B 3 marketplace || echo "   No marketplace in config.json"
          fi
          echo ""
          echo "   Deploying with wrangler..."
          wrangler pages deploy .vercel/output \
            --project-name=micropaywall \
            --branch=${{ github.ref_name }} \
            --commit-hash=${{ github.sha }} \
            --commit-message="${{ github.event.head_commit.message }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Purge Cloudflare Cache
        run: |
          echo "üßπ Purging Cloudflare cache to clear cached 503 responses..."
          
          # Check if jq is available, install if not
          if ! command -v jq &> /dev/null; then
            echo "   Installing jq for JSON parsing..."
            sudo apt-get update && sudo apt-get install -y jq || {
              echo "   ‚ö†Ô∏è  Could not install jq, using alternative method..."
              USE_JQ=false
            }
          else
            USE_JQ=true
          fi
          
          # Get zone ID from domain (micropaywall.app)
          if [ "$USE_JQ" = "true" ]; then
            ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=micropaywall.app" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" | jq -r '.result[0].id')
          else
            # Fallback: parse JSON without jq using grep/sed
            ZONE_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=micropaywall.app" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")
            ZONE_ID=$(echo "$ZONE_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"\([^"]*\)"/\1/')
          fi
          
          if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "null" ] || [ "$ZONE_ID" = "" ]; then
            echo "   ‚ö†Ô∏è  WARNING: Could not find zone ID for micropaywall.app"
            echo "   Cache purge skipped. You may need to purge manually from Cloudflare dashboard."
            echo "   To purge manually:"
            echo "   1. Go to https://dash.cloudflare.com/"
            echo "   2. Select micropaywall.app domain"
            echo "   3. Go to Caching ‚Üí Configuration ‚Üí Purge Everything"
            exit 0
          fi
          
          echo "   ‚úÖ Found zone ID: $ZONE_ID"
          
          # Purge everything (most aggressive - ensures all cached 503s are cleared)
          echo "   Purging all cached content..."
          RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}')
          
          if [ "$USE_JQ" = "true" ]; then
            SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
            if [ "$SUCCESS" = "true" ]; then
              echo "   ‚úÖ Cache purge successful"
              echo "   All cached responses (including 503 prefetch cache) have been cleared"
            else
              ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message // "Unknown error"')
              echo "   ‚ö†Ô∏è  WARNING: Cache purge failed: $ERROR"
              echo "   You may need to purge manually from Cloudflare dashboard"
            fi
          else
            # Check success without jq
            if echo "$RESPONSE" | grep -q '"success":true'; then
              echo "   ‚úÖ Cache purge successful"
              echo "   All cached responses (including 503 prefetch cache) have been cleared"
            else
              echo "   ‚ö†Ô∏è  WARNING: Cache purge may have failed"
              echo "   Response: $RESPONSE"
              echo "   You may need to purge manually from Cloudflare dashboard"
            fi
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

