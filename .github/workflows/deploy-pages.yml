name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Clean previous builds
        working-directory: apps/web
        run: |
          rm -rf .next .cache
          echo "‚úÖ Cleaned previous build artifacts"

      - name: Build Next.js app for Cloudflare Pages
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://api.micropaywall.app' }}
          NEXT_PUBLIC_SOLANA_RPC: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC || 'https://api.devnet.solana.com' }}
          NEXT_PUBLIC_SOLANA_RPC_MAINNET: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC_MAINNET || 'https://api.mainnet-beta.solana.com' }}
          NEXT_PUBLIC_SOLANA_NETWORK: ${{ secrets.NEXT_PUBLIC_SOLANA_NETWORK || 'devnet' }}
          NEXT_PUBLIC_WEB_URL: ${{ secrets.NEXT_PUBLIC_WEB_URL || 'https://micropaywall.app' }}
          # Disable all caching to prevent large cache files
          NEXT_CACHE: false
          WEBPACK_CACHE: false
          # Skip Sentry during Cloudflare build to avoid module resolution errors
          SKIP_SENTRY: 'true'
        run: npm run pages:build

      - name: Verify build output structure
        working-directory: apps/web
        run: |
          echo "üìÅ Verifying .vercel/output structure..."
          if [ ! -d ".vercel/output" ]; then
            echo "‚ùå ERROR: .vercel/output directory not found after build!"
            exit 1
          fi
          echo "‚úÖ Found .vercel/output directory"
          echo ""
          echo "üìÇ Directory contents:"
          ls -lah .vercel/output || echo "Cannot list directory"
          echo ""
          
          # Check for static directory
          if [ ! -d ".vercel/output/static" ]; then
            echo "‚ùå ERROR: static directory not found in .vercel/output"
            exit 1
          fi
          echo "‚úÖ Found static directory"
          echo "   Size: $(du -sh .vercel/output/static | cut -f1)"
          
          # Check for functions directory - CRITICAL for Next.js routing
          if [ ! -d ".vercel/output/functions" ]; then
            echo ""
            echo "‚ùå ERROR: functions directory not found!"
            echo "   This is required for Next.js routing on Cloudflare Pages"
            echo "   Without it, all routes will return 404"
            echo ""
            echo "   Checking if @cloudflare/next-on-pages generated output correctly..."
            exit 1
          fi
          echo "‚úÖ Found functions directory (needed for routing)"
          echo "   Size: $(du -sh .vercel/output/functions | cut -f1)"
          echo ""
          
          # Verify key files exist
          echo "üîç Verifying key routing files..."
          if [ -f ".vercel/output/functions/[[path]].js" ] || [ -d ".vercel/output/functions/[[path]]" ]; then
            echo "‚úÖ Found catch-all route handler ([[path]])"
          else
            echo "‚ö†Ô∏è  WARNING: Catch-all route handler not found - checking functions structure..."
            echo "   Functions directory contents:"
            ls -lah .vercel/output/functions | head -10
          fi
          
          if [ -f ".vercel/output/config.json" ]; then
            echo "‚úÖ Found config.json"
          else
            echo "‚ö†Ô∏è  WARNING: config.json not found"
          fi
          
          echo ""
          echo "üìä Build output summary:"
          echo "   Static files: $(find .vercel/output/static -type f 2>/dev/null | wc -l) files"
          echo "   Functions: $(find .vercel/output/functions -type f 2>/dev/null | wc -l) files"

      - name: Clean build output for deployment
        working-directory: apps/web
        run: |
          echo "üßπ Cleaning build output..."
          # Remove cache directories from .next before Cloudflare build
          rm -rf .next/cache cache .cache node_modules/.cache 2>/dev/null || true
          find .next -type d -name "cache" -exec rm -rf {} + 2>/dev/null || true
          find . -maxdepth 1 -type d -name "cache" -exec rm -rf {} + 2>/dev/null || true
          # Remove webpack pack files
          find .next -name "*.pack" -type f -delete 2>/dev/null || true
          find . -maxdepth 1 -name "*.pack" -type f -delete 2>/dev/null || true
          echo "‚úÖ Cleaned cache files before build"
      
      - name: Clean Cloudflare Pages output for deployment
        working-directory: apps/web
        run: |
          echo "üßπ Cleaning Cloudflare Pages output..."
          # Clean output directory if it exists
          rm -rf .vercel/output/static/cache 2>/dev/null || true
          # Remove any files larger than 25MB (Cloudflare Pages limit)
          find .vercel/output -type f -size +25M -exec rm -f {} + 2>/dev/null || true
          # Verify no large files remain
          echo "üìä Checking for remaining large files (>20MB)..."
          if [ -d ".vercel/output" ]; then
            LARGE_FILES=$(find .vercel/output -type f -size +20M 2>/dev/null | wc -l)
            if [ "$LARGE_FILES" -gt 0 ]; then
              echo "‚ö†Ô∏è  Found $LARGE_FILES large file(s):"
              find .vercel/output -type f -size +20M -exec ls -lh {} \; 2>/dev/null | head -10
              exit 1
            else
              echo "‚úÖ No large files found in output"
            fi
            echo "üìÅ Deployment directory structure (.vercel/output):"
            du -sh .vercel/output 2>/dev/null || echo "No output directory"
            echo "üìÅ Contents:"
            ls -lah .vercel/output 2>/dev/null || echo "Cannot list output"
          fi

      - name: List deployment structure before deploy
        working-directory: apps/web
        run: |
          echo "üì¶ Final deployment structure check:"
          echo ""
          echo "Root of .vercel/output:"
          ls -la .vercel/output/ | head -20
          echo ""
          echo "Static directory contents (first 10 items):"
          ls -la .vercel/output/static/ | head -10 || echo "Static not found"
          echo ""
          echo "Functions directory structure:"
          find .vercel/output/functions -type f -name "*.js" | head -10 || echo "No JS files in functions"
          echo ""
          echo "Checking for catch-all route:"
          ls -la .vercel/output/functions/ 2>/dev/null | grep -E "\[\[path\]\]|_worker|index" || echo "Catch-all route not found"
          echo ""
          echo "Checking for config.json:"
          cat .vercel/output/config.json 2>/dev/null || echo "config.json not found or not readable"
          echo ""
          echo "Verifying index.html exists:"
          ls -la .vercel/output/static/index.html 2>/dev/null || echo "index.html not found in static directory"

      - name: Verify critical files for routing
        working-directory: apps/web
        run: |
          echo "üîç Verifying critical routing files..."
          echo ""
          
          # Check for homepage files (index.html or prerender fallback)
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "‚úÖ Found index.html"
          elif [ -f ".vercel/output/static/index.prerender-fallback.html" ]; then
            echo "‚úÖ Found index.prerender-fallback.html (homepage fallback)"
          else
            echo "‚ö†Ô∏è  WARNING: No homepage file found (index.html or index.prerender-fallback.html)"
            echo "   Static directory contents:"
            ls -la .vercel/output/static/ | grep -E "index|404" | head -10
          fi
          
          # Check for functions directory
          if [ ! -d ".vercel/output/functions" ]; then
            echo "‚ùå ERROR: functions directory not found!"
            exit 1
          fi
          echo "‚úÖ Found functions directory"
          
          # Check for index function (homepage route handler)
          if [ -d ".vercel/output/functions/index.func" ] || [ -L ".vercel/output/functions/index.func" ]; then
            echo "‚úÖ Found index.func (homepage route handler)"
            # Check if it's a symlink and where it points
            if [ -L ".vercel/output/functions/index.func" ]; then
              LINK_TARGET=$(readlink .vercel/output/functions/index.func)
              echo "   ‚ö†Ô∏è  WARNING: index.func is a symlink pointing to: $LINK_TARGET"
              if [[ "$LINK_TARGET" != "index.rsc.func" ]] && [[ "$LINK_TARGET" != "./index.rsc.func" ]]; then
                echo "   ‚ùå ERROR: index.func should point to index.rsc.func, not $LINK_TARGET"
                echo "   This is likely causing the 404 error!"
              fi
            fi
          else
            echo "‚ö†Ô∏è  WARNING: index.func not found - checking for alternative structure..."
            ls -la .vercel/output/functions/ | grep -E "index|^\.\.?$" | head -10
          fi
          
          # Check for catch-all route handler (may not exist if all routes are pre-rendered)
          if [ -f ".vercel/output/functions/[[path]].js" ] || [ -d ".vercel/output/functions/[[path]].func" ] || [ -d ".vercel/output/functions/[[path]]" ]; then
            echo "‚úÖ Found catch-all route handler ([[path]])"
          else
            echo "‚ö†Ô∏è  WARNING: Catch-all route handler ([[path]]) not found"
            echo "   This may be OK if all routes are pre-rendered, but dynamic routes won't work"
            echo "   Functions directory contents:"
            ls -la .vercel/output/functions/ | head -15
          fi
          
          # Check for config.json and examine routing configuration
          if [ -f ".vercel/output/config.json" ]; then
            echo "‚úÖ Found config.json"
            echo "   Checking routing configuration..."
            if grep -q "routes" .vercel/output/config.json 2>/dev/null; then
              echo "   Routing configuration found in config.json"
            else
              echo "   ‚ö†Ô∏è  WARNING: No routing configuration found in config.json"
            fi
            echo "   Config.json preview (first 30 lines):"
            cat .vercel/output/config.json | head -30
          else
            echo "‚ùå ERROR: config.json not found - this is required!"
            exit 1
          fi
          
          # Check for middleware function
          if [ -d ".vercel/output/functions/middleware.func" ]; then
            echo "‚úÖ Found middleware.func"
          else
            echo "‚ö†Ô∏è  WARNING: middleware.func not found (middleware may not be working)"
          fi
          
          echo ""
          echo "üìä Summary:"
          echo "   Static files: $(find .vercel/output/static -type f 2>/dev/null | wc -l)"
          echo "   Function directories: $(find .vercel/output/functions -type d -name "*.func" 2>/dev/null | wc -l)"
          echo ""
          echo "‚úÖ Critical files verification complete"

      - name: Fix broken homepage route handler
        working-directory: apps/web
        run: |
          echo "üîß Fixing broken homepage route handler..."
          echo ""
          
          # First, diagnose the current state
          echo "üìã Current state:"
          if [ -L ".vercel/output/functions/index.func" ]; then
            LINK_TARGET=$(readlink .vercel/output/functions/index.func)
            echo "   index.func is a symlink ‚Üí $LINK_TARGET"
          elif [ -d ".vercel/output/functions/index.func" ]; then
            echo "   index.func is a directory"
          else
            echo "   index.func doesn't exist"
          fi
          
          # Check if index.rsc.func exists and what's in it
          if [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   ‚úÖ index.rsc.func directory exists"
            echo "   Contents of index.rsc.func:"
            ls -la .vercel/output/functions/index.rsc.func/ | head -10
            if [ -f ".vercel/output/functions/index.rsc.func/index.js" ]; then
              echo "   ‚úÖ index.js exists in index.rsc.func"
              echo "   First 20 lines of index.js:"
              head -20 .vercel/output/functions/index.rsc.func/index.js || echo "   Could not read index.js"
            else
              echo "   ‚ö†Ô∏è  index.js NOT found in index.rsc.func"
            fi
          else
            echo "   ‚ùå index.rsc.func directory does NOT exist"
          fi
          
          # Check static index.html
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "   ‚úÖ static/index.html exists ($(wc -c < .vercel/output/static/index.html) bytes)"
          else
            echo "   ‚ùå static/index.html NOT found"
          fi
          
          echo ""
          echo "üîß Applying fix strategy..."
          
          # Strategy: Since homepage is a pre-rendered client component, 
          # remove ALL function route handlers (both symlink and directory) and let Cloudflare serve the static file
          # This is more reliable for pre-rendered pages
          
          # Remove the symlink if it exists
          if [ -L ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.func" ]; then
            echo "   Removing index.func (function route handler symlink/directory)"
            rm -rf .vercel/output/functions/index.func
            echo "   ‚úÖ Removed index.func"
          fi
          
          # CRITICAL: Also remove index.rsc.func directory - Cloudflare Pages will try to use it
          # even if index.func is removed, causing 404 errors
          if [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   Removing index.rsc.func directory (function route handler)"
            rm -rf .vercel/output/functions/index.rsc.func
            echo "   ‚úÖ Removed index.rsc.func directory"
            echo "   ‚ÑπÔ∏è  This prevents Cloudflare from trying to use a broken function route"
          fi
          
          echo "   ‚ÑπÔ∏è  Cloudflare will now serve static/index.html for the homepage"
          
          # Also check and fix dashboard.func if it has the same issue
          if [ -L ".vercel/output/functions/dashboard.func" ]; then
            DASHBOARD_TARGET=$(readlink .vercel/output/functions/dashboard.func)
            if [[ "$DASHBOARD_TARGET" == "bookmarks.rsc.func" ]]; then
              echo "   üîß Fixing dashboard.func symlink..."
              rm -f .vercel/output/functions/dashboard.func
              if [ -d ".vercel/output/functions/dashboard.rsc.func" ]; then
                ln -s dashboard.rsc.func .vercel/output/functions/dashboard.func
                echo "   ‚úÖ Fixed dashboard.func"
              elif [ -d ".vercel/output/functions/dashboard" ]; then
                echo "   ‚ÑπÔ∏è  dashboard is a directory - no function symlink needed"
              else
                echo "   ‚ö†Ô∏è  dashboard.rsc.func not found - removed broken symlink"
              fi
            fi
          fi
          
          echo ""
          echo "‚úÖ Route handler fix complete"
          echo ""
          echo "üìã Final state:"
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "   ‚úÖ static/index.html exists - homepage will be served as static file"
            echo "   File size: $(wc -c < .vercel/output/static/index.html) bytes"
            echo "   First line: $(head -1 .vercel/output/static/index.html | cut -c1-80)"
          else
            echo "   ‚ùå static/index.html missing - this will cause 404!"
          fi
          
          if [ -L ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.func" ]; then
            echo "   ‚ö†Ô∏è  index.func still exists (should have been removed)"
          else
            echo "   ‚úÖ index.func removed - using static file serving"
          fi
          
          if [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   ‚ö†Ô∏è  index.rsc.func still exists (should have been removed)"
          else
            echo "   ‚úÖ index.rsc.func removed - using static file serving"
          fi
          
          # Verify no index-related functions remain
          echo ""
          echo "üîç Checking for any remaining index-related functions:"
          ls -la .vercel/output/functions/ | grep -E "^[^d].*index|^d.*index" || echo "   ‚úÖ No index-related functions found"

      - name: Verify static file serving configuration
        working-directory: apps/web
        run: |
          echo "üîç Verifying static file serving configuration..."
          echo ""
          
          # Check if 404.html exists (Cloudflare uses this for SPA routing)
          if [ -f ".vercel/output/static/404.html" ]; then
            echo "‚úÖ Found 404.html"
            echo "   This is used by Cloudflare Pages for handling unknown routes"
          else
            echo "‚ö†Ô∏è  404.html not found"
            echo "   This might be needed for client-side routing"
          fi
          
          # Verify index.html is in the correct location
          echo ""
          echo "üìã Verifying static/index.html:"
          if [ -f ".vercel/output/static/index.html" ]; then
            echo "   ‚úÖ static/index.html exists"
            echo "   Location: .vercel/output/static/index.html"
            echo "   Size: $(wc -c < .vercel/output/static/index.html) bytes"
            echo "   First 100 chars: $(head -c 100 .vercel/output/static/index.html)"
          else
            echo "   ‚ùå static/index.html NOT FOUND - this will cause 404!"
            echo "   Listing static directory:"
            ls -la .vercel/output/static/ | head -20
          fi
          
          # Check config.json routing rules
          if [ -f ".vercel/output/config.json" ]; then
            echo ""
            echo "üìã Checking config.json routing rules:"
            # Look for rules that might interfere with homepage serving
            if grep -q '"src": "/"' .vercel/output/config.json 2>/dev/null; then
              echo "   ‚ö†Ô∏è  Found routing rule for '/' - checking if it interferes:"
              grep -A 5 '"src": "/"' .vercel/output/config.json | head -10
            else
              echo "   ‚úÖ No explicit routing rule for '/' - static file will be served"
            fi
            
            # Check for redirect rules
            if grep -q '"status": 30' .vercel/output/config.json 2>/dev/null; then
              echo "   ‚ö†Ô∏è  Found redirect rules - checking:"
              grep -B 2 -A 3 '"status": 30' .vercel/output/config.json | head -15
            fi
          fi
          
          # Final check: Ensure no function routes interfere with homepage
          echo ""
          echo "üîç Final check - ensuring no function routes for homepage:"
          if [ -L ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.func" ] || [ -d ".vercel/output/functions/index.rsc.func" ]; then
            echo "   ‚ùå ERROR: Function route handlers still exist for homepage!"
            echo "   This will prevent static file serving"
            echo "   Remaining files:"
            ls -la .vercel/output/functions/ | grep index
            exit 1
          else
            echo "   ‚úÖ No function route handlers for homepage - static file will be served"
          fi
          
          echo ""
          echo "‚úÖ Configuration verification complete"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: micropaywall
          directory: apps/web/.vercel/output
          wranglerVersion: '3'
          branch: ${{ github.ref_name }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

