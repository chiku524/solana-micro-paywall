name: Deploy Converged Workers + Pages

on:
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
      - 'apps/backend-workers/**'
      - 'wrangler.toml'
      - 'package.json'
      - 'package-lock.json'
      - '.npmrc'
      - '.github/workflows/deploy-converged.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Converged Workers + Pages
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Enable Corepack
        run: corepack enable

      - name: Configure npm for peer dependencies
        run: npm config set legacy-peer-deps true
      
      - name: Install dependencies
        run: npm ci

      - name: Clean previous builds
        working-directory: apps/web
        run: |
          rm -rf .next .cache .vercel
          echo "‚úÖ Cleaned previous build artifacts"

      - name: Build Next.js app for Cloudflare Pages
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://api.micropaywall.app' }}
          NEXT_PUBLIC_SOLANA_RPC: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC || 'https://api.devnet.solana.com' }}
          NEXT_PUBLIC_SOLANA_RPC_MAINNET: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC_MAINNET || 'https://api.mainnet-beta.solana.com' }}
          NEXT_PUBLIC_SOLANA_NETWORK: ${{ secrets.NEXT_PUBLIC_SOLANA_NETWORK || 'devnet' }}
          NEXT_PUBLIC_WEB_URL: ${{ secrets.NEXT_PUBLIC_WEB_URL || 'https://micropaywall.app' }}
          # Disable all caching to prevent large cache files
          NEXT_CACHE: false
          WEBPACK_CACHE: false
          # Skip Sentry during Cloudflare build to avoid module resolution errors
          SKIP_SENTRY: 'true'
          BUILD_ID: ${{ github.sha }}
        run: |
          set -x
          echo "::group::üî® Building Next.js app for Converged Workers + Pages"
          echo "=========================================="
          echo "Build Step Starting"
          echo "=========================================="
          echo ""
          
          echo "::group::üìã Step 1: Running Next.js build"
          echo "Running: npm run build"
          npm run build
          BUILD_EXIT_CODE=$?
          echo "Next.js build exit code: $BUILD_EXIT_CODE"
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Next.js build failed with exit code $BUILD_EXIT_CODE"
            exit 1
          fi
          echo "‚úÖ Next.js build completed successfully"
          echo "::endgroup::"
          echo ""
          
          echo "::group::üìã Step 2: Running @cloudflare/next-on-pages"
          echo "This generates functions for edge runtime pages"
          echo "Running: npx @cloudflare/next-on-pages@latest"
          echo ""
          npx @cloudflare/next-on-pages@latest
          NEXT_ON_PAGES_EXIT_CODE=$?
          echo ""
          echo "@cloudflare/next-on-pages exit code: $NEXT_ON_PAGES_EXIT_CODE"
          if [ $NEXT_ON_PAGES_EXIT_CODE -ne 0 ]; then
            echo "‚ùå @cloudflare/next-on-pages failed with exit code $NEXT_ON_PAGES_EXIT_CODE"
            exit 1
          fi
          echo "‚úÖ @cloudflare/next-on-pages completed successfully"
          echo "::endgroup::"
          echo ""
          
          echo "‚úÖ Build completed successfully"
          echo "::endgroup::"

      - name: Install Wrangler CLI
        run: |
          echo "üì¶ Installing Wrangler CLI..."
          npm install -g wrangler
          wrangler --version

      - name: Verify build output
        working-directory: apps/web
        run: |
          echo "üîç Verifying build output..."
          if [ ! -d ".vercel/output" ]; then
            echo "‚ùå .vercel/output directory not found!"
            exit 1
          fi
          echo "‚úÖ .vercel/output directory exists"
          echo "üìÅ Contents:"
          ls -la .vercel/output/ | head -20
          echo ""
          echo "üìÅ Static files:"
          if [ -d ".vercel/output/static" ]; then
            ls -la .vercel/output/static/ | head -10
          else
            echo "‚ö†Ô∏è  No static directory found"
          fi

      - name: Deploy to Cloudflare Pages (Converged)
        working-directory: apps/web
        run: |
          echo "üöÄ Deploying converged Workers + Pages project..."
          echo ""
          echo "   Project: micropaywall"
          echo "   Branch: ${{ github.ref_name }}"
          echo "   Commit: ${{ github.sha }}"
          echo ""
          echo "   Deploying with wrangler..."
          wrangler pages deploy .vercel/output \
            --project-name=micropaywall \
            --branch=${{ github.ref_name }} \
            --commit-hash=${{ github.sha }} \
            --commit-message="${{ github.event.head_commit.message }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Purge Cloudflare Cache
        run: |
          echo "üßπ Purging Cloudflare cache to clear cached responses..."
          
          # Get zone ID from domain (micropaywall.app)
          ZONE_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=micropaywall.app" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          ZONE_ID=$(echo "$ZONE_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"\([^"]*\)"/\1/')
          
          if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "null" ] || [ "$ZONE_ID" = "" ]; then
            echo "‚ö†Ô∏è  Could not find zone ID for micropaywall.app, skipping cache purge"
          else
            echo "   Found zone ID: $ZONE_ID"
            echo "   Purging cache..."
            PURGE_RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"purge_everything":true}')
            
            if echo "$PURGE_RESPONSE" | grep -q '"success":true'; then
              echo "‚úÖ Cache purged successfully"
            else
              echo "‚ö†Ô∏è  Cache purge may have failed. Response: $PURGE_RESPONSE"
            fi
          fi

